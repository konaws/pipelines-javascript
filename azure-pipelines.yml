#pipeline 
trigger:
- feature/*

pr: none

variables:
  devConnection: 'FreeTrial'
  appName: 'devAppName'
#  rgName: 'testRG'


stages:
- stage: build
  displayName: 'Build'
  jobs:
  - job: build_test
    displayName: 'Build and test'
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    - task: NodeTool@0
      inputs:
        versionSpec: '10.x'
      displayName: 'Install Node.js'
    - script: |
        npm install
        npm run build
      displayName: 'npm install, build, test'
    - task: ArchiveFiles@2
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
        includeRootFolder: false
    - task: PublishPipelineArtifact@0
      inputs:
        targetPath: '$(System.ArtifactsDirectory)'

- stage: build_azure_resources
  displayName: 'Build Azure resources'
  dependsOn: build
  jobs:
  - job: build_arm
    displayName: "Build Azure resources"
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    - task: AzureResourceGroupDeployment@2
      inputs:
        azureSubscription: $(devConnection)
        action: 'Create Or Update Resource Group'
        templateLocation: 'Linked artifact'
        csmFile: 'ops/armTemplates/rg_template.json'
        csmParametersFile: 'ops/armTemplates/parameter_file.json'
        deploymentMode: 'Incremental'
  
- stage: deploy
  displayName: 'Deploy app'
  dependsOn: build_azure_resources
  jobs:
  - deployment: deployDev
    displayName: 'Deploy Dev'
    environment: 'TestEnv'
    strategy:
      runOnce:
        deploy:
          steps:
          - task: DownloadPipelineArtifact@1
            inputs:
              downloadPath: '$(System.DefaultWorkingDirectory)'
          - task: AzureWebApp@1
            inputs:
              azureSubscription: $(devConnection)
              appType: 'webAppLinux'
              appName: $(appName)
              runtimeStack: 'NODE|10.1'
              startUpCommand: 'npm run start'